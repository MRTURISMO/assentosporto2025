<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Assentos</title>
    <style>
        /* Estilo básico */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        h1, h2 {
            color: #333;
        }

        form, #painel-controle {
            margin-bottom: 20px;
        }

        input, select, button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background-color: #218838;
            opacity: 0.9;
        }

        #message-container {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f7f7f7;
        }

        #mapa-ônibus {
            margin: 20px 0;
            border: 1px solid #ccc;
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <h1>Reservar Assento</h1>
    <img src="https://i.ibb.co/8L8k0NVC/MAPA-POLTRONAS-PORTO25.png" alt="Mapa do Ônibus" id="mapa-ônibus">

    <form id="reserva-form">
        <input type="text" id="nome" placeholder="Seu Nome" required>
        <input type="text" id="cpf" placeholder="Seu CPF" required>
        <select id="escola" required>
            <option value="">Selecione a Escola</option>
            <option value="CED 03 - GUARÁ">CED 03 - GUARÁ</option>
            <option value="CEMI - GAMA">CEMI - GAMA</option>
            <option value="CEMEIT">CEMEIT</option>
            <option value="GG - GUARÁ">GG - GUARÁ</option>
            <option value="CEM URSO BRANCO">CEM URSO BRANCO</option>
        </select>
        <select id="assento" required>
            <option value="">Selecione um Assento</option>
            <!-- As opções de assentos serão geradas aqui -->
        </select>
        <button type="submit">Reservar</button>
    </form>

    <div id="message-container">
        <p id="message"></p>
    </div>

    <div id="painel-controle">
        <h2>Controle de Reservas</h2>
        <table id="tabela-reservas">
            <thead>
                <tr>
                    <th scope="col">Nome</th>
                    <th scope="col">Escola</th>
                    <th scope="col">Número do Assento</th>
                </tr>
            </thead>
            <tbody>
                <!-- As reservas serão adicionadas aqui -->
            </tbody>
        </table>
    </div>

    <script>
        // Simulação de um "banco de dados" de assentos  
        const assentos = {};

        // Inicializando os assentos de 01 a 64
        for (let i = 1; i <= 64; i++) {
            assentos[i.toString().padStart(2, '0')] = true;  // Formata para dois dígitos
        }

        // Objeto para rastrear reservas por CPF
        const reservasPorCPF = {};

        // Função para atualizar o select de assentos baseado na disponibilidade
        function atualizarAssentos() {
            const assentoSelect = document.getElementById('assento');
            assentoSelect.innerHTML = '<option value="">Selecione um Assento</option>'; // Limpa as opções

            const pisoSuperior = [];
            const pisoInferior = [];

            // Separa os assentos de acordo com o piso
            for (let assento in assentos) {
                if (assentos[assento]) { // Verifica se o assento está disponível
                    if (parseInt(assento) <= 52) {
                        pisoSuperior.push(assento);  // Piso Superior: 01 a 52
                    } else {
                        pisoInferior.push(assento);  // Piso Inferior: 53 a 64
                    }
                }
            }

            // Ordena os assentos do Piso Superior em ordem crescente
            pisoSuperior.sort((a, b) => parseInt(a) - parseInt(b));

            // Adiciona assentos do piso superior
            if (pisoSuperior.length > 0) {
                assentoSelect.appendChild(new Option('--- PISO SUPERIOR ---', ''));
                pisoSuperior.forEach(assento => {
                    const option = document.createElement('option');
                    option.value = assento;
                    option.textContent = assento;
                    assentoSelect.appendChild(option);
                });
            }

            // Adiciona assentos do piso inferior
            if (pisoInferior.length > 0) {
                assentoSelect.appendChild(new Option('--- PISO INFERIOR ---', ''));
                pisoInferior.forEach(assento => {
                    const option = document.createElement('option');
                    option.value = assento;
                    option.textContent = assento;
                    assentoSelect.appendChild(option);
                });
            }
        }

        // Função para validar o CPF
        function validarCPF(cpf) {
            // Remove caracteres não numéricos
            cpf = cpf.replace(/\D/g, '');

            // Verifica se o CPF possui 11 caracteres
            if (cpf.length !== 11) {
                return false;
            }

            // Verifica se todos os números são iguais
            if (/^(\d)\1{10}$/.test(cpf)) {
                return false;
            }

            // Validação do primeiro dígito verificador
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let digito1 = 11 - (soma % 11);
            if (digito1 === 10 || digito1 === 11) digito1 = 0;
            if (parseInt(cpf.charAt(9)) !== digito1) {
                return false;
            }

            // Validação do segundo dígito verificador
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            let digito2 = 11 - (soma % 11);
            if (digito2 === 10 || digito2 === 11) digito2 = 0;
            if (parseInt(cpf.charAt(10)) !== digito2) {
                return false;
            }

            return true;
        }

        // Função para reservar um assento
        function reservarAssento(event) {
            event.preventDefault(); // Evita o envio do formulário

            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;
            const escola = document.getElementById('escola').value;
            const assentoSelecionado = document.getElementById('assento').value;

            // Validação de CPF
            if (!validarCPF(cpf)) {
                mostrarMensagem('CPF inválido. Por favor, insira um CPF válido (somente números).', false);
                return;
            }

            // Verifica se o CPF já possui uma reserva
            if (reservasPorCPF[cpf]) {
                mostrarMensagem('Esse CPF já possui um assento reservado: ' + reservasPorCPF[cpf], false);
                return;
            }

            if (assentos[assentoSelecionado] && assentoSelecionado) {
                // Reserva o assento
                assentos[assentoSelecionado] = false;

                // Armazena a reserva relacionada ao CPF
                reservasPorCPF[cpf] = assentoSelecionado;

                // Adiciona a reserva à tabela
                const tabelaReservas = document.getElementById('tabela-reservas').querySelector('tbody');
                const novaLinha = tabelaReservas.insertRow();
                const nomeCell = novaLinha.insertCell(0);
                nomeCell.textContent = nome;
                const escolaCell = novaLinha.insertCell(1);
                escolaCell.textContent = escola;
                const assentoCell = novaLinha.insertCell(2);
                assentoCell.textContent = assentoSelecionado;

                // Envia os dados para o Google Sheets via fetch
                const formData = new FormData();
                formData.append('nome', nome);
                formData.append('cpf', cpf);
                formData.append('escola', escola);
                formData.append('assento', assentoSelecionado);

                fetch('https://script.google.com/macros/s/AKfycbyZD-2tpaI8okb4wS8__zTJRRLECLRGsLNbfBOWS5gXOhbeq52zsFn1L_fgVdOf6jtP/exec', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    mostrarMensagem('Reserva feita com sucesso!', true);
                })
                .catch(error => {
                    console.error('Erro ao enviar dados para o Google Sheets:', error);
                    mostrarMensagem('Erro ao enviar dados para o Google Sheets', false);
                });

                // Limpa o formulário
                document.getElementById('reserva-form').reset();
                atualizarAssentos(); // Atualiza a lista de assentos
            } else {
                mostrarMensagem('Esse assento já está reservado ou não existe.', false);
            }
        }

        // Função para mostrar mensagens
        function mostrarMensagem(mensagem, sucesso) {
            const messageContainer = document.getElementById('message-container');
            const messageElement = document.getElementById('message');
            messageElement.textContent = mensagem;
            messageContainer.style.display = 'block';

            if (!sucesso) {
                messageElement.style.color = '#dc3545';  // cor de erro
            } else {
                messageElement.style.color = '#155724';  // cor de sucesso
            }
        }

        // Inicializar a lista de assentos
        atualizarAssentos();

        // Adicionando o evento de submissão do formulário
        document.getElementById('reserva-form').addEventListener('submit', reservarAssento);
    </script>
</body>

</html>
